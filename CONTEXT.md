# VMMO Bot - Контекст разработки

## Обзор проекта
Бот для автоматизации игры VMMO (vmmo.vten.ru). Использует Playwright для управления браузером.

## Структура файлов

### Основные модули:
- **main.py** — точка входа, основной цикл бота
- **combat.py** — боевая логика (атака, скиллы, Адские Игры)
- **dungeon.py** — управление подземельями (вход, выход, переходы)
- **backpack.py** — работа с рюкзаком (аукцион, разбор, бонусы)
- **config.py** — конфигурация (URL, селекторы, настройки)
- **dungeon_config.py** — конфигурация подземелий
- **utils.py** — утилиты (задержки, логирование, клики)
- **navigation.py** — навигация и определение локации
- **popups.py** — закрытие попапов
- **stats.py** — статистика сессии

### Конфигурационные файлы:
- **settings.json** — пользовательские настройки
- **cookies.json** — куки для авторизации

## Ключевые селекторы

### Позиции юнитов:
- Наши юниты: `div.unit._unit-pos-11` до `_unit-pos-15`
- Вражеские юниты: `div.unit._unit-pos-21` до `_unit-pos-25`

### Источники (Адские Игры):
- Все источники: `a.source-link`
- Текущий: `._current`
- Заблокированный: `._lock`
- Зелёный (наш): `._side-light`
- Красный (враг): `._side-dark`

### Хранитель:
- `div.unit-show._keeper` внутри `div.unit._unit-pos-XX`

### Аукцион:
- Предупреждение о низкой цене: `span.feedbackPanelERROR` с текстом "ниже рыночной"
- Поля цены: `input[name='bidGold']`, `input[name='bidSilver']`, `input[name='buyoutGold']`, `input[name='buyoutSilver']`
- Кнопка создания лота: `input.go-btn[value='Создать лот']`

### Боевые:
- Кнопка атаки: `#ptx_combat_rich2_attack_link`
- Скиллы: `.wrap-skill-link._skill-pos-{1-5}` → `a.skill-link`
- Таймер скилла: `.time-counter`

### Кнопки навигации:
- Подземелья: `a.btn.nav-btn[href*="dungeons"]`
- Рюкзак: `a.btn.nav-btn[href="/backpack"]`

## Логика Адских Игр (fight_in_hell_games)

1. Переходим по URL `HELL_GAMES_URL`
2. Цикл до истечения времени:
   - Проверяем наличие врагов на позициях 21-25
   - Если враги есть → используем скиллы → атакуем
   - Если врагов нет → переходим в рандомный доступный источник
   - Если все источники заблокированы → ждём
3. По окончании возвращаемся в подземелья

## Логика аукциона (sell_on_auction)

1. Находим кнопку "На аукцион"
2. Получаем цену конкурента
3. Рассчитываем цену: (цена_конкурента / кол-во) * наше_кол-во - 1 серебро
4. Пытаемся создать лот
5. Если появляется предупреждение "Цена ниже рыночной":
   - Повышаем цену на 1 серебро
   - Пробуем снова (макс 20 попыток)
6. Повторяем для всех предметов

## Последние изменения

### Watchdog система (anti-stuck):
- **utils.py**: `reset_watchdog()`, `is_watchdog_triggered()`, `get_watchdog_idle_time()`
- **popups.py**: `emergency_unstuck(page)` — аварийный выход из застревания
- Таймаут: 2 минуты без активности → поиск кнопок → hard reset на /dungeons
- Кнопки поиска: "Продолжить бой", "Продолжить", "В подземелье", "Начать бой", "Закрыть", "Выйти", "Назад"

### Поддержка сервера (Linux):
- `msvcrt` теперь опциональный (только Windows)
- Аргументы командной строки:
  - `--headless` — запуск без GUI
  - `--server` — режим сервера (headless + без клавиатуры)

### Адские Игры:
- Добавлена функция `has_enemies_hell()` — проверяет врагов на позициях 21-25
- Добавлена функция `find_random_source()` — ищет рандомный доступный источник
- Логика: бьём врагов, если нет — переходим в рандомный источник

### Аукцион:
- Добавлена функция `has_low_price_warning()` — проверяет предупреждение о низкой цене
- Добавлена функция `try_create_lot()` — создаёт лот с автоповышением цены
- Исправлен цикл зависания при низкой цене

## Известные особенности

1. Скиллы имеют КД ~2 сек после использования
2. После перехода в источник нужна задержка 3+ сек
3. Клики через `dispatch_event("click")` работают в фоне
4. URL с "dungeoncompleted" = страница завершения данжена

## Настройки (settings.json)

```json
{
  "backpack_threshold": 15,
  "max_no_units": 5,
  "restart_interval": 7200,
  "start_dungeon_index": 0
}
```

## Запуск

### Windows (локально):
```bash
python main.py
```

### Linux сервер (с виртуальным дисплеем):
```bash
# Установка
pip install playwright
playwright install firefox
playwright install-deps

# Запуск с Xvfb (рекомендуется)
apt install xvfb
xvfb-run python main.py --server

# Или headless режим (может детектиться)
python main.py --headless
```

### Аргументы:
- `--headless` — без GUI (для серверов без Xvfb)
- `--server` — режим сервера (headless + без клавиатурного управления)
