# Контекст: VMMO Dungeon Bot - Warrior

## Общее описание
Автоматизированный бот для браузерной игры VMMO (vmmo.vten.ru), написанный на Python с использованием Playwright. Бот автоматически проходит подземелья (dungeons) в игре.

## Структура проекта

```
warrior/
├── main.py                 # Точка входа, основной цикл бота
├── config.py               # Константы, URL, селекторы
├── utils.py                # Вспомогательные функции
├── combat.py               # Боевые функции, скиллы, Адские Игры
├── dungeon.py              # Управление данженами, вход/выход
├── dungeon_config.py       # Конфигурация данженов (порядок, названия)
├── backpack.py             # Управление рюкзаком, аукцион, разборка
├── popups.py               # Обработка попапов и виджетов
├── login_and_save_cookies.py  # Утилита для сохранения cookies
├── cookies.json            # Авторизационные куки
└── vmmo_bot2_dungeon_context.md  # Этот файл контекста
```

## Зависимости
- `playwright` - для автоматизации браузера (Firefox)

---

## Модули

### config.py - Конфигурация

#### Основные настройки
| Константа | Значение | Описание |
|-----------|----------|----------|
| `SCRIPT_DIR` | auto | Путь к папке скрипта |
| `BACKPACK_THRESHOLD` | 15 | Порог заполненности рюкзака для очистки |
| `MAX_NO_UNITS_ATTEMPTS` | 40 | Максимум попыток без юнитов перед переходом дальше |
| `RESTART_INTERVAL` | 7200 | Интервал перезапуска сессии (2 часа) |
| `MAX_ENTER_FAILURES` | 2 | Макс. ошибок входа перед принудительным обновлением |

#### URL-ы
| Константа | URL | Описание |
|-----------|-----|----------|
| `BASE_URL` | `https://vmmo.vten.ru` | Главная |
| `DUNGEONS_URL` | `https://vmmo.vten.ru/dungeons?52` | Подземелья |
| `HELL_GAMES_URL` | `https://vmmo.vten.ru/basin/combat` | Адские Игры |

#### Селекторы боя
| Константа | Селектор | Описание |
|-----------|----------|----------|
| `DUNGEONS_BUTTON_SELECTOR` | `a.btn.nav-btn[href*="dungeons"]` | Кнопка возврата в список подземелий |
| `ATTACK_SELECTOR` | `#ptx_combat_rich2_attack_link` | Кнопка атаки |
| `UNIT_SELECTORS` | `.unit._unit-pos-21` ... `25` | Позиции врагов (21-25) |

#### Селекторы рюкзака
| Константа | Селектор | Описание |
|-----------|----------|----------|
| `BACKPACK_LINK_SELECTOR` | `a.main-menu-link._rack[title="Рюкзак"]` | Ссылка на рюкзак |
| `BACKPACK_COUNT_SELECTOR` | `a.main-menu-link._rack .link-text` | Счётчик "11/28" |
| `CONFIRM_BUTTON_SELECTOR` | `span.go-btn-in` | Кнопка подтверждения |

#### Селекторы попапов
| Константа | Селектор | Описание |
|-----------|----------|----------|
| `POPUP_CLOSE_SELECTOR` | `a.popup-close-link` | Закрытие попапа достижений |
| `WIDGET_LEAVE_PARTY_SELECTOR` | `div.widget a.go-btn[href*="leaveParty"]` | Виджет "Покинуть банду" |
| `COMBAT_LOOT_SELECTOR` | `div.combat-loot` | Лут в бою |
| `REST_BONUS_POPUP_SELECTOR` | `div.popup-inner img[src*="rest-buff"]` | Попап бонуса отдыха |
| `REST_BONUS_CONTINUE_SELECTOR` | `div.popup-inner a.go-btn` | Кнопка "Продолжить" в попапе бонуса |

---

### utils.py - Вспомогательные функции

| Функция | Описание |
|---------|----------|
| `antibot_delay(base, spread)` | Рандомная задержка для обхода антибот-защиты |
| `log(message)` | Вывод сообщения с временной меткой |
| `parse_cooldown_time(cd_text)` | Парсит время КД ("14м 30с" → секунды) |
| `format_duration(seconds)` | Форматирует секунды в "Xм Yс" |
| `safe_click(page, selector, timeout)` | Безопасный клик через dispatch_event (работает в фоне) |
| `safe_click_element(element)` | Безопасный клик по элементу через dispatch_event |

**Важно:** `safe_click` и `safe_click_element` используют `dispatch_event("click")` вместо прямого клика, что позволяет боту работать даже когда окно браузера не в фокусе.

---

### popups.py - Обработка попапов

| Функция | Описание |
|---------|----------|
| `close_achievement_popup(page)` | Закрывает модальное окно "Новое достижение" |
| `close_party_widget(page)` | Закрывает виджет приглашения в данжен ("Покинуть банду") |
| `close_rest_bonus_popup(page)` | Закрывает попап ежедневного бонуса отдыха |
| `close_all_popups(page)` | Закрывает все известные попапы и виджеты |
| `collect_loot(page)` | Собирает лут (combat-loot) во время боя |

---

### backpack.py - Управление рюкзаком

| Функция | Описание |
|---------|----------|
| `get_backpack_count(page)` | Получает счётчик рюкзака (current, max) |
| `need_cleanup_backpack(page)` | Проверяет нужна ли очистка (>= 15 предметов) |
| `open_backpack(page)` | Открывает рюкзак |
| `find_button_by_text(page, text, selector)` | Универсальный поиск кнопки по тексту |
| `find_auction_button(page)` | Ищет кнопку "На аукцион" |
| `find_disassemble_button(page)` | Ищет кнопку "Разобрать" |
| `sell_on_auction(page)` | Выставляет предметы на аукцион (приоритет 1) |
| `disassemble_items(page)` | Разбирает предметы (приоритет 2) |
| `cleanup_backpack_if_needed(page)` | Главная функция очистки рюкзака |

**Приоритеты очистки:**
1. Аукцион - сначала выставляем на аукцион
2. Разборка - затем разбираем оставшееся

---

### combat.py - Боевые функции

| Функция | Описание |
|---------|----------|
| `units_present(page)` | Проверяет наличие врагов на поле боя |
| `use_skills(page)` | Использует доступные скиллы (позиции 1-5) |
| `check_dungeon_status(page)` | Проверяет статус: "stage_complete" / "dungeon_complete" / None |
| `click_continue_battle(page)` | Нажимает "Продолжить бой" |
| `handle_stuck(page)` | Обработка застревания (ищет любую кнопку "Продолжить") |
| `check_death(page)` | Проверяет смерть персонажа, выходит из боя |
| `switch_random_location(page)` | Переход в случайную локацию (для Адских Игр) |
| `fight_in_hell_games(page, duration_seconds)` | Сражается в "Адских Играх" пока данжены на КД |

---

### dungeon.py - Управление данженами

| Функция | Описание |
|---------|----------|
| `force_refresh(page)` | Принудительное обновление страницы |
| `check_dungeon_cooldown(page, dungeon_id)` | Проверяет кулдаун данжена |
| `find_next_available_dungeon(page, current_index)` | Ищет следующий данжен без КД |
| `get_min_cooldown_time(page)` | Находит минимальное время КД |
| `enter_dungeon(page, dungeon_id)` | Вход в данжен: клик → сложность → войти → начать бой |
| `go_to_next_dungeon(page, current_index, enter_failure_count)` | Переход к следующему данжену |

---

### dungeon_config.py - Конфигурация данженов

Содержит:
- `DUNGEON_ORDER` - порядок прохождения данженов (список ID)
- `DUNGEONS` - словарь с параметрами каждого данжена (name, need_difficulty)
- `DIFFICULTY_SELECTOR` - селектор повышения сложности
- `START_DUNGEON_INDEX` - начальный индекс данжена

---

## Логика работы (main.py)

### Инициализация
1. Запуск Firefox через Playwright (не headless, fullscreen 1920x1080)
2. Загрузка cookies из `cookies.json` (относительный путь от SCRIPT_DIR)
3. Переход на страницу данженов
4. Проверка и очистка рюкзака

### Основной цикл
```
WHILE True:
    1. Проверка времени для перезапуска (каждые 2 часа)
    2. Закрытие попапов (достижения, бонус отдыха)
    3. Сбор лута (если есть)
    4. Проверка смерти → если умер, переход к следующему данжену
    5. Проверка статуса подземелья:
       - "stage_complete" → нажать "Продолжить бой"
       - "dungeon_complete" → перейти к следующему данжену
    6. Использование скиллов
    7. Проверка наличия юнитов:
       - Есть юниты → атака
       - Нет юнитов → счётчик no_units_attempts
       - 40+ попыток → handle_stuck() или следующий данжен
    8. Антибот-задержка
```

### Обработка кулдаунов
- Если все данжены на КД → получить минимальное время КД
- Перейти в "Адские Игры" на это время
- После возвращения снова искать доступный данжен

### Автоперезапуск
- Каждые 2 часа сессия перезапускается
- Внешний `while True` в `__main__` обеспечивает бесконечный цикл

---

## Флоу работы бота

```
┌─────────────────────────────────────────────────────────────┐
│                        СТАРТ                                 │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  Загрузка cookies → Переход на /dungeons?52                 │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  Проверка рюкзака (>= 15?) → Аукцион → Разборка             │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  Поиск доступного данжена (без КД)                          │
│  Все на КД? → Адские Игры на min(КД)                        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  Закрытие попапов/виджетов → Вход в данжен                  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     ОСНОВНОЙ ЦИКЛ БОЯ                        │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ 1. Закрытие попапов (достижения, бонус отдыха)     │    │
│  │ 2. Сбор лута                                        │    │
│  │ 3. Проверка смерти                                  │    │
│  │ 4. Проверка статуса (этап/данжен пройден)           │    │
│  │ 5. Использование скиллов                            │    │
│  │ 6. Атака / Обработка застревания                    │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┼───────────────┐
              ▼               ▼               ▼
        ┌──────────┐   ┌──────────┐   ┌──────────┐
        │ Смерть   │   │ Данжен   │   │ 2 часа   │
        │          │   │ пройден  │   │ прошло   │
        └──────────┘   └──────────┘   └──────────┘
              │               │               │
              └───────────────┼───────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  Переход к следующему данжену / Перезапуск сессии           │
└─────────────────────────────────────────────────────────────┘
```

---

## Особенности реализации

### Работа в фоне
Все клики выполняются через `dispatch_event("click")` вместо прямого `page.click()`. Это позволяет боту работать даже когда окно браузера находится в фоне или не в фокусе.

### Обработка попапов
- **Попап достижений** - закрывается автоматически в каждой итерации
- **Попап бонуса отдыха** - закрывается автоматически
- **Виджет "Покинуть банду"** - закрывается перед входом в данжен

### Застревание
- Если 40+ попыток без юнитов → `handle_stuck()` ищет любую кнопку "Продолжить"
- Если кнопка не найдена → переход к следующему данжену

### Обработка ошибок входа
- Счётчик `enter_failure_count` отслеживает неудачные попытки
- После 2 неудач → `force_refresh()` (принудительное обновление страницы)

---

## Запуск

```bash
# Через bat-файл
run_warrior.bat

# Или напрямую
cd C:\Users\Faiz\Desktop\warrior
python main.py
```

## Утилиты

### login_and_save_cookies.py
Скрипт для авторизации и сохранения cookies:
1. Открывает браузер
2. Вводит логин/пароль
3. Сохраняет cookies в `cookies.json`
